name: Deploy to cPanel Staging

on:
  workflow_dispatch:
    inputs:
      trigger:
        description: 'What triggered this deploy (e.g. wp-tour-update-123)'
        required: false
        default: 'manual'
      slug:
        description: 'Post slug that changed (for selective cache invalidation)'
        required: false
        default: ''
      post_type:
        description: 'Post type that changed (post, page, tour)'
        required: false
        default: ''
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Cache API data
        uses: actions/cache@v4
        with:
          path: |
            .astro/zaui-cache
            .astro/wordpress-cache
          key: ${{ runner.os }}-api-cache-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-api-cache-

      - name: Invalidate changed content cache
        if: contains(github.event.inputs.trigger || '', 'wp-')
        run: |
          SLUG="${{ github.event.inputs.slug }}"
          echo "Content change detected (trigger: ${{ github.event.inputs.trigger }})"
          
          if [ -z "$SLUG" ] || [ ! -d ".astro/wordpress-cache" ]; then
            echo "No slug provided or no cache dir — clearing all WordPress cache"
            rm -rf .astro/wordpress-cache
          else
            echo "Selectively invalidating cache for slug: $SLUG"
            # Compute MD5 hashes of the cache keys that need invalidation
            # and delete only those files. Keeps taxonomy/sitenav/review caches.
            node -e "
              const crypto = require('crypto');
              const fs = require('fs');
              const path = require('path');
              const dir = '.astro/wordpress-cache';
              const slug = '${SLUG}';
              
              // Cache keys to invalidate:
              // 1. Individual tour by slug (both languages)
              // 2. Aggregated tour lists (both languages)
              // 3. Tour list queries (all variations)
              const keys = [
                'tour-slug:en:' + slug,
                'tour-slug:zh:' + slug,
                'all-tours:en',
                'all-tours:zh',
              ];
              
              // Also invalidate any tours:* list query caches
              if (fs.existsSync(dir)) {
                // Since we can't reverse MD5 hashes, delete all tour list caches
                // by scanning for keys starting with 'tours:'
                const allFiles = fs.readdirSync(dir);
                const keysToDelete = keys.map(k => crypto.createHash('md5').update(k).digest('hex') + '.json');
                
                let deleted = 0;
                for (const hash of keysToDelete) {
                  const fp = path.join(dir, hash);
                  if (fs.existsSync(fp)) {
                    fs.unlinkSync(fp);
                    deleted++;
                    console.log('Deleted: ' + hash);
                  }
                }
                
                // Also delete tours: list query caches (we need to brute-force check common patterns)
                const listKeys = [
                  'tours:en:{}',
                  'tours:zh:{}',
                  'tours:en:{\"per_page\":100,\"page\":1}',
                  'tours:zh:{\"per_page\":100,\"page\":1}',
                ];
                for (const k of listKeys) {
                  const hash = crypto.createHash('md5').update(k).digest('hex') + '.json';
                  const fp = path.join(dir, hash);
                  if (fs.existsSync(fp)) {
                    fs.unlinkSync(fp);
                    deleted++;
                    console.log('Deleted list cache: ' + hash);
                  }
                }
                
                console.log('Invalidated ' + deleted + ' cache files, kept ' + (allFiles.length - deleted) + ' (taxonomy/nav/reviews)');
              }
            "
          fi

      - name: Build Astro (cPanel staging)
        run: |
          # Use cPanel config (adds base: '/staging', output: 'static')
          cp astro.config.mjs astro.config.mjs.bak
          cp astro.config.cpanel.mjs astro.config.mjs

          # Exclude server-only files (require Cloudflare SSR adapter)
          if [ -f "src/pages/api/webhook/zaui.ts" ]; then
            mv src/pages/api/webhook/zaui.ts src/pages/api/webhook/zaui.ts.cpanel-exclude
          fi

          npx -y tsx scripts/prefetch-zaui.js
          npm run build

          # Restore original config
          mv astro.config.mjs.bak astro.config.mjs
          if [ -f "src/pages/api/webhook/zaui.ts.cpanel-exclude" ]; then
            mv src/pages/api/webhook/zaui.ts.cpanel-exclude src/pages/api/webhook/zaui.ts
          fi

          # Add .htaccess for clean URLs on Apache
          cp public/.htaccess-staging dist/.htaccess
        env:
          PUBLIC_WORDPRESS_CUSTOM_API_URL: https://qualitour.ca/app/wp-json/qualitour/v1
          ZAUI_API_TOKEN: ${{ secrets.ZAUI_API_TOKEN }}
          ZAUI_API_URL: ${{ secrets.ZAUI_API_URL }}
          ZAUI_ACCOUNT_ID: ${{ secrets.ZAUI_ACCOUNT_ID }}
          ZAUI_USER_ID: ${{ secrets.ZAUI_USER_ID }}

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Upload files via FTP
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          lftp -c "
            set ftp:ssl-allow no
            set ftp:passive-mode true
            set net:timeout 30
            set net:max-retries 3
            set net:reconnect-interval-base 5
            open -u $FTP_USERNAME,$FTP_PASSWORD $FTP_HOST
            cd public_html/staging

            # Phase 1: Upload _astro/ assets (hashed filenames — only new files transfer)
            mirror -R --verbose --parallel=4 --ignore-time --no-perms --delete \
              --exclude-glob .DS_Store \
              --include-glob _astro/ \
              dist/ .

            # Phase 2: Force re-upload everything else (HTML, .htaccess, etc.)
            # HTML content changes every build (JS hash references) even if file size is the same
            mirror -R --verbose --parallel=4 --no-perms --delete --transfer-all \
              --exclude-glob .DS_Store \
              --exclude-glob .git/ \
              --exclude-glob _astro/ \
              dist/ .
          "
