---
import "../styles/global.css";
import { getCurrentLocale, type Locale } from "../i18n/config";
import SiteNavAstro from "../components/SiteNavAstro.astro";
import { getSiteNavData, type SiteNavData } from "../lib/wordpress/api";
import { sanitizeUrls } from "../lib/wp-url";
import { getPrivateTransfersWithPricing } from "../lib/zaui/zaui";
import Footer from "../components/Footer.astro";
import SeoHead from "../components/SeoHead.astro";

interface TourTranslation {
  id: number;
  slug: string;
}

interface Props {
  title?: string;
  description?: string;
  image?: string;
  heroImage?: string; // LCP image to preload
  type?: "website" | "article" | "profile";
  lang?: Locale;
  canonical?: string;
  noindex?: boolean;
  tourTranslations?: {
    en?: TourTranslation;
    zh?: TourTranslation;
  };
}

const {
  title = "Qualitour | Vancouver Tour Operator & Global Visa Services",
  description = "Qualitour offers premium Canadian tours, private transfers in Vancouver, and expert global visa services. Experience authentic journeys with our professional team.",
  image,
  heroImage,
  type = "website",
  lang,
  canonical,
  noindex,
  tourTranslations,
} = Astro.props;

// Get current locale from URL or use provided lang
const currentLocale = lang || getCurrentLocale(Astro.url);
const htmlLang = currentLocale === "zh" ? "zh-CN" : "en";

// Fetch navigation data at build time
let navData: SiteNavData = {
  activities: [],
  destinations: [],
  durations: [],
  types: [],
  transfers: [],
};

try {
  const [siteNavData, transfers] = await Promise.all([
    getSiteNavData(currentLocale),
    getPrivateTransfersWithPricing(),
  ]);

  // Sanitize navigation data to remove local URLs
  navData = sanitizeUrls({
    ...siteNavData,
    transfers,
  });
} catch (e) {
  console.error("Failed to fetch nav data:", e);
}
---

<!doctype html>
<html lang={htmlLang}>
  <head>
    <SeoHead
      title={title}
      description={description}
      image={image}
      heroImage={heroImage}
      type={type}
      canonical={canonical}
      noindex={noindex}
    />
  </head>
  <body
    class="min-h-screen flex flex-col bg-gray-900 text-gray-100 antialiased"
  >
    <!-- Navigation (Pure Astro - no React runtime needed) -->
    <SiteNavAstro
      lang={currentLocale}
      destinations={navData.destinations}
      activities={navData.activities}
      types={navData.types}
      durations={navData.durations}
      tourTranslations={tourTranslations}
    />

    <!-- Main Content -->
    <main class="flex-1">
      <slot />
    </main>

    <!-- Footer -->
    <Footer lang={currentLocale} />
  </body>
</html>

<style is:global>
  :root {
    --font-inter: "Inter", system-ui, sans-serif;
  }
  body {
    font-family: var(--font-inter);
  }
</style>
